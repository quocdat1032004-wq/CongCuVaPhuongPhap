{% extends "base.html" %}
{% block title %}Chi Tiết Hóa Đơn #{{ order.MaHoaDon }}{% endblock %}

{% block content %}
<h2>Chi Tiết Hóa Đơn #{{ order.MaHoaDon }}</h2>
<p><strong>Ngày tạo:</strong> {{ order.NgayTao.strftime('%d-%m-%Y %H:%M:%S') }}</p>

{# --- Logic phân biệt Người tạo và Người xử lý --- #}
{% if order.nguoi_tao %}
    {# Kiểm tra vai trò của người tạo để hiển thị nhãn phù hợp #}
    {% if order.nguoi_tao.vai_tro.TenVaiTro == 'Thực khách' %}
        <p><strong>Khách hàng đặt:</strong> {{ order.nguoi_tao.HoTen }}</p>
    {% else %}
        <p><strong>Nhân viên tạo (Tại quầy):</strong> {{ order.nguoi_tao.HoTen }}</p>
    {% endif %}
{% endif %}

{# Hiển thị Người xử lý nếu có #}
<p><strong>Nhân viên xử lý/Duyệt:</strong>
    {% if order.nguoi_xu_ly %}
        {{ order.nguoi_xu_ly.HoTen }}
    {% else %}
        <span class="text-muted">(Chờ xử lý)</span>
    {% endif %}
</p>

<p><strong>Trạng thái:</strong> {{ order.TrangThaiDonHang }}</p>

<h4 class="mt-4">Chi tiết món ăn</h4>
<table class="table">
    <thead>
        <tr>
            <th>Tên Món Ăn</th>
            <th>Số Lượng</th>
            <th>Đơn Giá</th>
            <th>Thành Tiền</th>
        </tr>
    </thead>
    <tbody>
        {% for item in order.ChiTiet.all() %}
        <tr>
            <td>{{ item.mon_an.TenMonAn if item.mon_an else 'N/A' }}</td>
            <td>{{ item.SoLuong }}</td>
            <td>{{ "{:,.0f}".format(item.DonGia) }} VNĐ</td>
            <td>{{ "{:,.0f}".format(item.ThanhTien) }} VNĐ</td>
        </tr>
        {% endfor %}
    </tbody>
    <tfoot>
        <tr>
            <th colspan="3" class="text-end">Tổng cộng:</th>
            <th>{{ "{:,.0f}".format(order.TongTien) }} VNĐ</th>
        </tr>
    </tfoot>
</table>
<a href="{{ request.referrer or url_for('order.history') }}" class="btn btn-secondary">Quay lại</a>
{% endblock %}